module Jellyfish.Relevance.Semantics where
open import Jellyfish.Prelude          renaming (_âˆ‹_ to _âˆ‹ğ“¢_)
open import Jellyfish.Relevance.Syntax renaming (_âˆ‹_ to _âˆ‹ğ“˜_)

âŒˆ_âŒ‰âˆ‹ : âˆ€ {Î“ A} {âŒŠÎ“âŒ‹ : Subset Î“} â†’ âŒŠÎ“âŒ‹ âˆ‹ğ“˜ A â†’ âŒˆ âŒŠÎ“âŒ‹ âŒ‰ âˆ‹ğ“¢ A
âŒˆ ze âŒ‰âˆ‹ = ze
âŒˆ_âŒ‰âˆ‹ {âŒŠÎ“âŒ‹ = _ â–» outside} (su x) =    âŒˆ x âŒ‰âˆ‹
âŒˆ_âŒ‰âˆ‹ {âŒŠÎ“âŒ‹ = _ â–»  inside} (su x) = su âŒˆ x âŒ‰âˆ‹

mutual
  {-# TERMINATING #-}
  âŸ¦_âŸ§ : Ty â†’ Set
  âŸ¦ â„•     âŸ§ = Nat
  âŸ¦ A â‡’ B âŸ§ = âˆƒ Î» Î“ â†’ âˆƒ Î» (âŒŠÎ“âŒ‹ : Subset Î“) â†’ Env âŒŠÎ“âŒ‹ Ã— â†‘â½ A â¾ âŒŠÎ“âŒ‹ âŠ¢ B

  Env : âˆ€ {Î“} (âŒŠÎ“âŒ‹ : Subset Î“) â†’ Set
  Env âŒŠÎ“âŒ‹ = All âŸ¦_âŸ§ âŒˆ âŒŠÎ“âŒ‹ âŒ‰

mutual
  {-# TERMINATING #-}
  eval : âˆ€ {Î“} {âŒŠÎ“âŒ‹ : Subset Î“} (âŒŠÏâŒ‹ : Env âŒŠÎ“âŒ‹) â†’ âˆ€ {A} â†’ âŒŠÎ“âŒ‹ âŠ¢ A â†’ âŸ¦ A âŸ§
  eval âŒŠÏâŒ‹ (lit n)        = n
  eval âŒŠÏâŒ‹ (add eâ‚ eâ‚‚)    = eval âŒŠÏâŒ‹ eâ‚ + eval âŒŠÏâŒ‹ eâ‚‚
  eval âŒŠÏâŒ‹ (sub eâ‚ eâ‚‚)    = eval âŒŠÏâŒ‹ eâ‚ - eval âŒŠÏâŒ‹ eâ‚‚
  eval âŒŠÏâŒ‹ (mul eâ‚ eâ‚‚)    = eval âŒŠÏâŒ‹ eâ‚ * eval âŒŠÏâŒ‹ eâ‚‚
  eval âŒŠÏâŒ‹ (ifz eâ‚ eâ‚‚ eâ‚ƒ) = case eval âŒŠÏâŒ‹ eâ‚ of Î» where
                            (zero)  â†’ eval âŒŠÏâŒ‹ eâ‚‚
                            (suc n) â†’ eval âŒŠÏâŒ‹ eâ‚ƒ
  eval âŒŠÏâŒ‹ (var x)        = find âŒŠÏâŒ‹ âŒˆ x âŒ‰âˆ‹
  eval âŒŠÏâŒ‹ (lam e)        = _ , _ , âŒŠÏâŒ‹ , e
  eval âŒŠÏâŒ‹ (app eâ‚ eâ‚‚)    = apply (eval âŒŠÏâŒ‹ eâ‚) (eval âŒŠÏâŒ‹ eâ‚‚)
  eval âŒŠÏâŒ‹ (lÎµt eâ‚ eâ‚‚)    = let a = eval âŒŠÏâŒ‹ eâ‚
                          in eval (âŒŠÏâŒ‹ â–» a) eâ‚‚

  apply : âˆ€ {A B} â†’ âŸ¦ A â‡’ B âŸ§ â†’ âŸ¦ A âŸ§ â†’ âŸ¦ B âŸ§
  apply (_ , _ , Ïâ€² , e) a = eval (Ïâ€² â–» a) e

infix 4 _âŠ¢_â‡“_
data _âŠ¢_â‡“_ {Î“} {âŒŠÎ“âŒ‹ : Subset Î“} (âŒŠÏâŒ‹ : Env âŒŠÎ“âŒ‹) : âˆ€ {A} â†’ âŒŠÎ“âŒ‹ âŠ¢ A â†’ âŸ¦ A âŸ§ â†’ Set where
  lit : âˆ€ n
    -----------------
    â†’ âŒŠÏâŒ‹ âŠ¢ lit n â‡“ n

  add : âˆ€ {eâ‚ eâ‚‚ nâ‚ nâ‚‚}
    â†’ âŒŠÏâŒ‹ âŠ¢ eâ‚        â‡“ nâ‚
    â†’ âŒŠÏâŒ‹ âŠ¢ eâ‚‚        â‡“ nâ‚‚
    ---------------------------
    â†’ âŒŠÏâŒ‹ âŠ¢ add eâ‚ eâ‚‚ â‡“ nâ‚ + nâ‚‚

  sub : âˆ€ {eâ‚ eâ‚‚ nâ‚ nâ‚‚}
    â†’ âŒŠÏâŒ‹ âŠ¢ eâ‚        â‡“ nâ‚
    â†’ âŒŠÏâŒ‹ âŠ¢ eâ‚‚        â‡“ nâ‚‚
    ---------------------------
    â†’ âŒŠÏâŒ‹ âŠ¢ sub eâ‚ eâ‚‚ â‡“ nâ‚ - nâ‚‚

  mul : âˆ€ {eâ‚ eâ‚‚ nâ‚ nâ‚‚}
    â†’ âŒŠÏâŒ‹ âŠ¢ eâ‚        â‡“ nâ‚
    â†’ âŒŠÏâŒ‹ âŠ¢ eâ‚‚        â‡“ nâ‚‚
    ---------------------------
    â†’ âŒŠÏâŒ‹ âŠ¢ mul eâ‚ eâ‚‚ â‡“ nâ‚ * nâ‚‚

  ifz/t : âˆ€ {A eâ‚ eâ‚‚ eâ‚ƒ} {a : âŸ¦ A âŸ§}
    â†’ âŒŠÏâŒ‹ âŠ¢ eâ‚           â‡“ zero
    â†’ âŒŠÏâŒ‹ âŠ¢ eâ‚‚           â‡“ a
    ---------------------------
    â†’ âŒŠÏâŒ‹ âŠ¢ ifz eâ‚ eâ‚‚ eâ‚ƒ â‡“ a

  ifz/f : âˆ€ {A eâ‚ eâ‚‚ eâ‚ƒ n} {a : âŸ¦ A âŸ§}
    â†’ âŒŠÏâŒ‹ âŠ¢ eâ‚           â‡“ suc n
    â†’ âŒŠÏâŒ‹ âŠ¢ eâ‚ƒ           â‡“ a
    ----------------------------
    â†’ âŒŠÏâŒ‹ âŠ¢ ifz eâ‚ eâ‚‚ eâ‚ƒ â‡“ a

  var : âˆ€ {A} (x : âŒŠÎ“âŒ‹ âˆ‹ğ“˜ A)
    -------------------------------
    â†’ âŒŠÏâŒ‹ âŠ¢ var x â‡“ find âŒŠÏâŒ‹ âŒˆ x âŒ‰âˆ‹

  lam : âˆ€ {A B} {e : â†‘â½ A â¾ âŒŠÎ“âŒ‹ âŠ¢ B}
    ---------------------------------
    â†’ âŒŠÏâŒ‹ âŠ¢ lam e â‡“ (_ , _ , âŒŠÏâŒ‹ , e)

  app : âˆ€ {A B eâ‚ eâ‚‚} {Î“â€²} {âŒŠÎ“â€²âŒ‹ : Subset Î“â€²} {e : â†‘â½ A â¾ âŒŠÎ“â€²âŒ‹ âŠ¢ B} {âŒŠÏâ€²âŒ‹ : Env âŒŠÎ“â€²âŒ‹} {a : âŸ¦ A âŸ§} {b : âŸ¦ B âŸ§}
    â†’ âŒŠÏâŒ‹      âŠ¢ eâ‚        â‡“ (_ , _ , âŒŠÏâ€²âŒ‹ , e)
    â†’ âŒŠÏâŒ‹      âŠ¢ eâ‚‚        â‡“ a
    â†’ âŒŠÏâ€²âŒ‹ â–» a âŠ¢ e         â‡“ b
    -------------------------------------------
    â†’ âŒŠÏâŒ‹      âŠ¢ app eâ‚ eâ‚‚ â‡“ b

  lÎµt : âˆ€ {A B eâ‚ eâ‚‚} {a : âŸ¦ A âŸ§} {b : âŸ¦ B âŸ§}
    â†’ âŒŠÏâŒ‹     âŠ¢ eâ‚        â‡“ a
    â†’ âŒŠÏâŒ‹ â–» a âŠ¢ eâ‚‚        â‡“ b
    -------------------------
    â†’ âŒŠÏâŒ‹     âŠ¢ lÎµt eâ‚ eâ‚‚ â‡“ b
